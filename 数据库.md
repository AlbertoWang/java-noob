[TOC]

# 数据库设计原则

## 范式 *Normal Format*

### 第一范式 1NF：字段的原子性

关系型数据库默认满足1NF。

### 第二范式 2NF：消除对主键的部分依赖

新增一个独立字段作为主键（ID）。

### 第三范式 BCNF：消除对主键的传递依赖

将表拆分为多个，独立数据独立建表。

## 事务

### 事务特性

1. 原子性 *Atomicity*

   事务的操作要么全成功提交，要么全失败回滚；

2. 一致性 *Consistency*

   事务必须使数据库从一个一致性状态（事务提交前）转移到另一个一致性状态（事务提交后）；

3. 隔离性 *Isolation*

   并发产生的事务之间不能相互干扰，无法感知其他并行事务的发生；

4. 持久性 *Durability*

   事务一旦提交，对数据库的改变就是永久性的，即使数据库产生故障也不会丢失事务操作。

### 事务隔离级别

针对事务的隔离性，有着从低到高的4种隔离界别：

1. *Read Uncommitted*

   事务正在访问数据并产生修改，但还没提交到数据库中，若另一个事务也访问了该数据，这个数据就成为脏数据，即第二个事务发生了**脏读**；

2. *Read Committed* （SQL Server和Oracle默认隔离界别）

   事务只能读到其他事务已经提交的数据（解决了**脏读**），但如果在读的过程中，另一个事务将数据修改并提交，第一个事务再次读这个数据的时候就会发现不一致，即第一个事务发生了**不可重复读**；

3. *Repeated Read* （MySQL默认隔离级别）

   事务进行中，其他事务不能修改第一个事务使用中的数据（解决了**脏读**和**不可重复读**），但如果第一个事务进行中，另一个事务新增/删除了一条数据，有可能会影响第一个事务的数据，即第一个数据发生了**幻读**；

4. *Serializable*

   事务串行化按序执行（解决了**脏读**、**不可重复读**和**幻读**），但效率差开销高。

# MySQL



## 存储引擎

### MyISAM

### InnoDB

### 引擎选择

* MyISAM：读写、插入为主；
* InnoDB：更新、删除频高，保证数据完整性，并发量高，需要支持事务/外键。

## 数据库优化

## 常用语法

### 时间处理

`DATE_FORMAT(<colName>, '%Y-%m-%d %H:%i:%s')`

* 按小时取：

  ```sql
  SELECT DATE_FORMAT(<dateCol>, '%Y-%m-%d %H') as `hour`, COUNT(*)
  FROM <tableName>
  GROUP BY `hour`
  ```

* 按每隔一段时间（30min为例），使用`CONCAT()`构造出`GROUP BY`条件：

  ```sql
  SELECT
  	DATE_FORMAT(
  		CONCAT( DATE( <dateCol> ), ' ', HOUR ( <dateCol> ), ':', 
      	( FLOOR( MINUTE ( <dateCol> ) / 30 ) * 30 ) ),
  		'%Y-%m-%d %H:%i' 
  		) AS `min`,
      COUNT(*)
  FROM
  	<tableName>
  GROUP BY `min`
  ```

  